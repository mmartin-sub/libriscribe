% ===================================================================
% PRINTER PROFILE: LULU.COM (v3 - Final)
%
% PURPOSE:
%   - Sets page geometry for the INTERIOR PDF.
%   - Dynamically calculates gutter based on page count using the
%     standard `refcount` and `lastpage` packages.
%
% USAGE:
%   - \input{this_file.tex} in your main template's preamble.
% ===================================================================

% 1. Load essential, standard packages using \RequirePackage.
\RequirePackage{etoolbox}
\RequirePackage{lastpage}   % Provides the `LastPage` label.
\RequirePackage{refcount}   % Provides `\getrefnumber` to read the label as a number.
\RequirePackage{geometry}

% 2. Define Lulu's fixed specifications.
\newlength{\luluBleedAmount}
\setlength{\luluBleedAmount}{0.125in}
\newlength{\luluOuterSafetyMargin}
\setlength{\luluOuterSafetyMargin}{0.5in}

% 3. Calculate the full bleed paper size from Pandoc variables.
\newlength{\bookwidthcore}
\newlength{\bookheightcore}
\setlength{\bookwidthcore}{$book-width-core$}
\setlength{\bookheightcore}{$book-height-core$}

\newlength{\calculatedpaperwidth}
\newlength{\calculatedpaperheight}
\setlength{\calculatedpaperwidth}{\dimexpr\bookwidthcore + 2\luluBleedAmount\relax}
\setlength{\calculatedpaperheight}{\dimexpr\bookheightcore + 2\luluBleedAmount\relax}

% 4. Defer the final geometry setup until the page count is known.
\AtBeginDocument{%
  \newlength{\luluGutterMargin}

  % === DYNAMIC GUTTER LOGIC (using \ifnum and \getrefnumber) ===
  % This is the standard, robust method for numerical comparison of labels.

  % --- HARDCOVER GUTTER REQUIREMENTS ---
  \ifstrequal{$binding-type$}{hardcover}{%
    \ifnum\getrefnumber{LastPage}>500
      \setlength{\luluGutterMargin}{1.175in}%
    \else
      \ifnum\getrefnumber{LastPage}>300
        \setlength{\luluGutterMargin}{1.05in}%
      \else
        \ifnum\getrefnumber{LastPage}>150
          \setlength{\luluGutterMargin}{0.925in}%
        \else
          \setlength{\luluGutterMargin}{0.8in}%
        \fi
      \fi
    \fi
  }{}% Empty 'else' part

  % --- PAPERBACK GUTTER REQUIREMENTS ---
  \ifstrequal{$binding-type$}{paperback}{%
    \ifnum\getrefnumber{LastPage}>500
      \setlength{\luluGutterMargin}{0.875in}%
    \else
      \ifnum\getrefnumber{LastPage}>300
        \setlength{\luluGutterMargin}{0.75in}%
      \else
        \ifnum\getrefnumber{LastPage}>150
          \setlength{\luluGutterMargin}{0.625in}%
        \else
          \setlength{\luluGutterMargin}{0.5in}%
        \fi
      \fi
    \fi
  }{}% Empty 'else' part

  % 5. Apply the final, calculated geometry.
  \geometry{
    paperwidth=\calculatedpaperwidth,
    paperheight=\calculatedpaperheight,
    top=\dimexpr\luluBleedAmount + \luluOuterSafetyMargin\relax,
    bottom=\dimexpr\luluBleedAmount + \luluOuterSafetyMargin\relax,
    outer=\dimexpr\luluBleedAmount + \luluOuterSafetyMargin\relax,
    inner=\dimexpr\luluBleedAmount + \luluGutterMargin\relax,
    includehead,
    includefoot
    %showframe % Uncomment to visualize layout boxes during debugging
  }
}