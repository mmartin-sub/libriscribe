% --- Document Class & KOMA-Script Options ---
\documentclass[$if(fontsize)$$fontsize$,$endif$$for(classoption)$$classoption$$sep$,$endfor$]{scrbook}

% Set KOMA-Script options from YAML
$if(koma-options)$
  \KOMAoptions{$koma-options$}
$endif$

% ===================================================================
% PREAMBLE: PACKAGE LOADING AND CONFIGURATION
% ===================================================================

% 1. Core Utilities & KOMA-Script Components
% \usepackage{etoolbox} is loaded by the printer profile
\usepackage{calc}     % Needed for \dimexpr calculations.
\usepackage{scrlayer-scrpage} % KOMA-Script's advanced page style package. Load early.

% 2. Geometry and Printer-Specific Setup
% This block is now modular. It inputs a printer-specific configuration file.
% The path to this file should be set via the 'printer-profile' variable in YAML or CLI.
$if(printer-profile)$
  \input{$printer-profile$}
$else$
  % Fallback geometry if no profile is provided (optional)
  \usepackage[a4paper, margin=1in]{geometry}
  \usepackage{etoolbox} % Ensure etoolbox is loaded if not in profile
$endif$

% 3. PDF/A Compliance and Hyperlink Setup (Corrected Logic)
$if(pdfa)$
#  \usepackage[a-3u,mathxmp]{pdfx}
  \usepackage[x-303]{pdfx}
$else$
  \usepackage{hyperref}
$endif$

% 4. Color and Graphics
\usepackage{graphicx}
\usepackage{tikz}

% 5. Configure Hyperref (loaded by pdfx or manually)
\hypersetup{
  final,
  colorlinks=$if(colorlinks)$$colorlinks$$else$true$endif$,
  urlcolor=$if(urlcolor)$$urlcolor$$else$blue$endif$,
  linkcolor=$if(linkcolor)$$linkcolor$$else$blue$endif$,
  citecolor=$if(citecolor)$$citecolor$$else$blue$endif$,
  breaklinks=true,
  bookmarksnumbered=true,
  bookmarksopen=true
}
\usepackage{bookmark}

% 6. Font and Language Setup (Requires LuaLaTeX)
\usepackage{fontspec}
\setmainfont[$for(mainfontoptions)$$mainfontoptions$$sep$,$endfor$]{$mainfont$}
$if(sansfont)$\setsansfont[$for(sansfontoptions)$$sansfontoptions$$sep$,$endfor$]{$sansfont$}$endif$
$if(monofont)$\setmonofont[$for(monofontoptions)$$monofontoptions$$sep$,$endfor$]{$monofont$}$endif$
$if(mathfont)$\usepackage{unicode-math}\setmathfont{$mathfont$}$endif$

\usepackage{polyglossia}
\setdefaultlanguage{$lang$}
$if(otherlangs)$\setotherlanguages{$otherlangs$}$endif$

% Emoji Font Fallback
\directlua{luaotfload.add_fallback ("emojifallback", {
  "Noto Color Emoji:mode=harf;", "Segoe UI Emoji:mode=harf;", "Apple Color Emoji:mode=harf;"
})}

% 7. Typography and Text Handling
\usepackage[final]{microtype}
\usepackage{csquotes}
% \usepackage{lastpage} is loaded by the printer profile

% 8. Header and Footer Configuration
\clearpairofpagestyles
\ihead{\usekomafont{pageheadfoot}$if(header-left)$$header-left$$endif$}
\ohead{\usekomafont{pageheadfoot}$if(header-right)$$header-right$$endif$}
\ifoot*{\usekomafont{pageheadfoot}$if(footer-left)$$footer-left$$endif$}
\ofoot*{\usekomafont{pageheadfoot}$if(footer-right)$$footer-right$$endif$}
\setkomafont{pageheadfoot}{\normalfont\small\sffamily}

% 9. Custom Page Styles & Helpers
\newcommand{\AddBackgroundColorLayer}[1]{\AddToShipoutPictureBG{\AtPageLowerLeft{\color{#1}\rule{\paperwidth}{\paperheight}}}}
\newcommand{\AddBackgroundImageLayer}[1]{\AddToShipoutPictureBG{\AtPageCenter{\includegraphics[width=\paperwidth,height=\paperheight,keepaspectratio=false]{#1}}}}
\DeclareNewPageStyle{customPage}{}{\clearpairofpagestyles[empty]}

$if(custom-coverpage)$
  $if(cover-background-color)$\definecolor{coverbgcolor}{HTML}{$cover-background-color$}$endif$
$endif$
$if(custom-lastpage)$
  $if(lastpage-background-color)$\definecolor{lastpagebgcolor}{HTML}{$lastpage-background-color$}$endif$
$endif$

% 10. Code Block Highlighting with tcolorbox
% \input{my-highlighting.tex}

% 11. User-defined Header Includes from YAML
$for(header-includes)$
$header-includes$
$endfor$

% ===================================================================
% DOCUMENT METADATA
% ===================================================================
$if(title)$\title{$title$}$endif$
$if(subtitle)$\subtitle{$subtitle$}$endif$
$if(author)$\author{$for(author)$$author$$sep$ \and $endfor$}$endif$
$if(date)$\date{$date$}$endif$
$if(rights)$\publishers{$rights$}$endif$
$if(subject)$\subject{$subject$}$endif$

% ===================================================================
% DOCUMENT BODY
% ===================================================================
\begin{document}

% --- Custom Cover Page ---
$if(custom-coverpage)$
  \thispagestyle{customPage}
  $if(cover-background-color)$\AddBackgroundColorLayer{coverbgcolor}$endif$
  $if(cover-image-path)$\AddBackgroundImageLayer{$cover-image-path$}$endif$
  \begin{titlepage}
    \centering
    \vfill
    {\usekomafont{title}\Huge $title$\par}
    \vspace{1cm}
    {\usekomafont{subtitle}\Large $subtitle$\par}
    \vfill
    {\usekomafont{author}\LARGE $for(author)$$author$$sep$ \and $endfor$\par}
    \vfill
  \end{titlepage}
$else$
  $if(titlepage)$\maketitle$endif$
$endif$

% --- Front Matter ---
\frontmatter
$if(toc)$\tableofcontents$endif$
$if(lof)$\listoffigures$endif$
$if(lot)$\listoftables$endif$

% --- Main Content ---
\mainmatter
$if(chapter-starts-on-right)$\preto\chapter{\cleardoublepage}$endif$

$body$

% --- Back Matter ---
\backmatter
$if(bibliography)$
  \printbibliography
$endif$

% --- Custom Last Page (Colophon) ---
$if(custom-lastpage)$
  \cleardoublepage
  \thispagestyle{customPage}
  $if(lastpage-background-color)$\AddBackgroundColorLayer{lastpagebgcolor}$endif$
  $if(lastpage-image-path)$\AddBackgroundImageLayer{$lastpage-image-path$}$endif$
  $if(lastpage-tex-path)$\input{$lastpage-tex-path$}$endif$
  \clearpage
$endif$

\end{document}